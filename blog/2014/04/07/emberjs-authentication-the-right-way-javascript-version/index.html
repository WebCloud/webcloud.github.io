
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ember.js Authentication - the right way (Javascript version) - WebCloud</title>
  <meta name="author" content="Vinicius Dallacqua">

  
  <meta name="description" content="Authentication, Ember.js, Javascript Ember.js Authentication - the right way (Javascript version) We all know that Ember.js is a great example of &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://WebCloud.github.io/blog/2014/04/07/emberjs-authentication-the-right-way-javascript-version">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/styles.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="WebCloud" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.sidr.min.js"></script>
  <script src="/javascripts/ah-blue.js"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-49265498-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head> 

<body   >
  <div class="aux-container">
    <a id="nav-toggle" href="#sidr"></a>
    <a id="search-toggle"></a>
</div>

<header class="header-container clearfix">
        <a href="/"><img src="/images/logo-big.png"></a>
</header>


  <div class="main-container">
    <div class="main wrapper clearfix">
    	
    	<aside>
			
			  	<div class="search-container">
					<form action="http://google.com/search" method="get">
						<fieldset role="search">
							<input type="hidden" name="q" value="site:blog.alexharr.is" />
							<input class="search-field" type="text" name="q" results="0" placeholder=""/>
							<input class="submit" type="submit" value=""/>
						</fieldset>
					</form>
				</div>
			
		  <div id="main-nav">
    <nav>
        <ul>
        	<li>
        		
					
<section>
	<span>
		<img src="http://www.gravatar.com/avatar/b01d191fc06f99caa0f007c44e3d2688" alt="Gravatar of Vinicius Dallacqua " title="Gravatar of Vinicius Dallacqua" />
	</span>
</section>
<h3>Recent Posts</h3>
<ul>
	
    <li>
    	<a href="/blog/2014/05/07/memoizing-with-javascript-experiment/">Memoizing with Javascript - experiment</a>
    </li>
    
    <li>
    	<a href="/blog/2014/04/07/emberjs-authentication-the-right-way/">Ember.js Authentication - the right way</a>
    </li>
    
    <li>
    	<a href="/blog/2014/04/07/emberjs-authentication-the-right-way-javascript-version/">Ember.js Authentication - the right way (Javascript version)</a>
    </li>
    
</ul>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/webcloud">@webcloud</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'webcloud',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+ViniciusDallacqua?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



				
        	</li>
        </ul>
    </nav>
</div>
		</aside>
		
      <div>
<article>
	<header>
  <div class="article-tags">
      

<span class="categories">
  
    <a class='category' href='/blog/categories/authentication/'>Authentication</a>, <a class='category' href='/blog/categories/ember-dot-js/'>Ember.js</a>, <a class='category' href='/blog/categories/javascript/'>Javascript</a>
  
</span>


  </div>
  
    <h1>
      Ember.js Authentication - the right way (Javascript version)
    </h1>
  
</header>

  <section><p>We all know that Ember.js is a great example of how using a front end framework can make your development workflow more powerful. But to use it correctly means to make your life easier.</p>

<p>There are some great articles demonstrating how you can setup your first Ember.js application, but now you have came to a decisive point, user authentication.</p>

<!--more-->


<p><img src="http://i.imgur.com/BevCJ3W.png" alt="Ember.js Authentication - the right way" /></p>

<div class="info warn">
Preffer the Coffescript taste? <a href="/blog/2014/04/07/emberjs-authentication-the-right-way/">Click here</a>
</div>


<h1>So you want to authenticate users with Ember.js</h1>

<p>Ember.js&rsquo;s built in objects and structure are great, to use them correctly is to enjoy all it&rsquo;s power. So you wonder, what is the best way to use Ember.js&rsquo;s and it&rsquo;s well grounded structure to build your user&rsquo;s authentication?</p>

<h1>The API</h1>

<p>This article will not cover the authentication api part, because it&rsquo;s already well covered on good articles like codeberry&rsquo;s <a href="http://coderberry.me/blog/2013/07/08/authentication-with-emberjs-part-1/">Authentication With EmberJS &ndash; Part 1</a>, which we will use in this example, but we&rsquo;ll use the <code>rails</code> gem instead of the <code>rails-api</code> gem to make use of the assets pipeline.</p>

<p>The part two on that article deals with the authentication task through EmberJS with an AuthManager component, which is clever idea, but it follows a path that leads to deal with the authentication part as a component, which leads to step outside of the framework&rsquo;s path in some cases, like accessing the store object outside of a route or controller. And it can lead to some problems or difficulties in the future.</p>

<h1>Setting up your project</h1>

<p>All the code for this article can be found on <a href="https://github.com/WebCloud/EmberJS-Auth-Example/tree/js-version">EmberJS-Auth-Example</a> github project, api and front end code. Before running, make sure you have ruby 2 and bundler installed. Then, to run the project from the project&rsquo;s folder simply run:</p>

<pre><code>bundle &amp;&amp; rake db:migrate &amp;&amp; rails s
</code></pre>

<p>You will then be able to access <a href="http://localhost:3000">http://localhost:3000</a></p>

<h1>First things first, bootstrap your Ember.js app</h1>

<p>Now, lets first create our application&rsquo;s main object with the following code:</p>

<figure class='code'><figcaption><span>app/assets/javascript/application.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">Auth</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Application</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">LOG_TRANSITIONS</span><span class="o">:</span>          <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">LOG_TRANSITIONS_INTERNAL</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make our development and debugging easier, It&rsquo;s defined that we will see all our transitions logs on the console, to help you even further I sugges to install the <a href="https://chrome.google.com/webstore/detail/ember-inspector/bmdblncegkenkacieihfhpjfppoconhi?hl=en">Ember Inspector</a>.</p>

<p>After creating the base application object let&rsquo;s create our routes:</p>

<figure class='code'><figcaption><span>app/assets/javascript/router.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Auth</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">resource</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;logout&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">resource</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;signup&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/user/:user_id&#39;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;secret&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The idea is to have the <code>this.route('secret')</code> only available to authenticated users.</p>

<h1>Using the REST adapter</h1>

<p>We will use the RESTAdapter provided by Ember Data (<strong>Ember.DS</strong>) to make our comunication with our REST api much easier and simple. To do so, <a href="http://emberjs.com/guides/getting-started/using-other-adapters/">overwrite the default</a> adapter:</p>

<figure class='code'><figcaption><span>app/assets/javascript/store.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Auth</span><span class="p">.</span><span class="nx">ApplicationAdapter</span> <span class="o">=</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">RESTAdapter</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Building your models</h1>

<p>The idea is to have the Ember application communicating to the api sending a access_token to validate the authenticated user&rsquo;s session on the protected urls. To do so, we will have two models, User and ApiKey:</p>

<figure class='code'><figcaption><span>app/assets/javascript/models/user.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Auth</span><span class="p">.</span><span class="nx">User</span> <span class="o">=</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">name</span><span class="o">:</span>                  <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">email</span><span class="o">:</span>                 <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">username</span><span class="o">:</span>              <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">password</span><span class="o">:</span>              <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">password_confirmation</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">apiKeys</span><span class="o">:</span>               <span class="nx">DS</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="s1">&#39;apiKey&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">errors</span><span class="o">:</span>                <span class="p">{}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/assets/javascript/models/api_key.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Auth</span><span class="p">.</span><span class="nx">ApiKey</span> <span class="o">=</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">accessToken</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">user</span><span class="o">:</span>        <span class="nx">DS</span><span class="p">.</span><span class="nx">belongsTo</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">async</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The ApiKey model won&rsquo;t communicate with the api, because the only time it&rsquo;s really requested is on the login action. So we will overwrite the rest adapter for that model, using local storage:</p>

<figure class='code'><figcaption><span>app/assets/javascript/store.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Auth</span><span class="p">.</span><span class="nx">ApiKeyAdapter</span> <span class="o">=</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">LSAdapter</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">namespace</span><span class="o">:</span> <span class="s1">&#39;emberauth-keys&#39;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Building the Sessions controller</h1>

<p>This controller should authenticate any user with a valid login and password through our api and store the access_key to be used on our protected pages. Based on that let&rsquo;s build our login action.</p>

<p>First let&rsquo;s get our data provided from the form and send an POST request to our /sessions api:</p>

<figure class='code'><figcaption><span>loginUser action on app/assets/javascript/controllers/sessions_controller.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// get the properties sent from the form and if there is any attemptedTransition set</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">attemptedTrans</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;attemptedTransition&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span>           <span class="k">this</span><span class="p">.</span><span class="nx">getProperties</span><span class="p">(</span><span class="s1">&#39;username_or_email&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// clear the form fields</span>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">setProperties</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">username_or_email</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">password</span><span class="o">:</span>          <span class="kc">null</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// send a POST request to the /sessions api with the form data</span>
</span><span class='line'><span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/session&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// set the ajax header with the returned access_token object</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">api_key</span><span class="p">.</span><span class="nx">access_token</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">401</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// if there is a authentication error the user is informed of it to try again</span>
</span><span class='line'>    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;wrong user or password, please try again&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can notice that it&rsquo;s being used the <code>Ember.$.post</code> method, that&rsquo;s no more than a wrapper to the jQuery&rsquo;s <code>$.post()</code> method but it returns a Ember promisse back to us, to know more about Ember Promssies see Ember&rsquo;s <a href="http://emberjs.com/guides/routing/asynchronous-routing/">Asynchronous Routing</a> guide. If the user is signed in we set the ajax headers to carry our access_token returned from the api, and if the user has a invalid login/password combination we send an alert message.</p>

<p>After the login, we should fetch our user&rsquo;s data and link the user to the returned access_token with a ApiKey record, to than take our user to the secret route. So let&rsquo;s expand our authentication action with the following code:</p>

<figure class='code'><figcaption><span>loginUser action on app/assets/javascript/controllers/sessions_controller.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// create a apiKey record on the local storage based on the returned object</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">).</span><span class="nx">createRecord</span><span class="p">(</span><span class="s1">&#39;apiKey&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">accessToken</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">api_key</span><span class="p">.</span><span class="nx">access_token</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// find a user based on the user_id returned from the request to the /sessions api</span>
</span><span class='line'><span class="nx">_this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">api_key</span><span class="p">.</span><span class="nx">user_id</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// set this controller token &amp; current user properties</span>
</span><span class='line'>  <span class="c1">// based on the data from the user and access_token</span>
</span><span class='line'>  <span class="nx">_this</span><span class="p">.</span><span class="nx">setProperties</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">token</span><span class="o">:</span>       <span class="nx">response</span><span class="p">.</span><span class="nx">api_key</span><span class="p">.</span><span class="nx">access_token</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">currentUser</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">getProperties</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// set the relationship between the User and the ApiKey models &amp; save the apiKey object</span>
</span><span class='line'>  <span class="nx">key</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">key</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;apiKeys&#39;</span><span class="p">).</span><span class="nx">content</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// check if there is any attemptedTransition to retry it or go to the secret route</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">attemptedTrans</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">attemptedTrans</span><span class="p">.</span><span class="nx">retry</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">_this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;attemptedTransition&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">_this</span><span class="p">.</span><span class="nx">transitionToRoute</span><span class="p">(</span><span class="s1">&#39;secret&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can notice that we also set our controller&rsquo;s token and currentUser properties with the data returned from the login action:</p>

<pre><code>_this.setProperties({
  token:       response.api_key.access_token,
  currentUser: user.getProperties('username', 'name', 'email')
});
</code></pre>

<p>That will be used to future verifications from the protected pages to proceed or not with the requests that comes to them and print out our user data.</p>

<p>We will also have to provide a way to the application reset our <code>SessionController</code> properties that contains user information when he logs out:</p>

<figure class='code'><figcaption><span>reset function on app/assets/javascript/controllers/sessions_controller.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// reset the controller properties and the ajax header</span>
</span><span class='line'><span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">setProperties</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">username_or_email</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">password</span><span class="o">:</span>          <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">token</span><span class="o">:</span>             <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">currentUser</span><span class="o">:</span>       <span class="kc">null</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="s1">&#39;Bearer none&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is a good idea to store the authenticated user&rsquo;s data either on local storage or cookies to allow them to keep their session if they close the browser window/tab. In this example we will go with cookies and the jQuery cookie plugin.</p>

<figure class='code'><figcaption><span>tokenChanged on app/assets/javascript/controllers/sessions_controller.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// create a observer binded to the token property of this controller</span>
</span><span class='line'><span class="c1">// to set/remove the authentication tokens</span>
</span><span class='line'><span class="nx">tokenChanged</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">Ember</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">removeCookie</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">removeCookie</span><span class="p">(</span><span class="s1">&#39;auth_user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;auth_user&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;currentUser&#39;</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}).</span><span class="nx">observes</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s created an observer binded to the token property of the SessionsController object, to automatically remove or instantiate the cookies based on the values of that property.</p>

<p>And finally let&rsquo;s bootstrap our SessionController so when the user tries to access it&rsquo;s route (either being redirected or directly visiting it&rsquo;s path) he can instantiate the properties with the cookies value, avoiding having to re-login if he had a previous session saved.</p>

<figure class='code'><figcaption><span>app/assets/javascript/controllers/sessions_controller.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// initialization method to verify if there is a access_token cookie set</span>
</span><span class='line'><span class="c1">// so we can set our ajax header with it to access the protected pages</span>
</span><span class='line'><span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">},</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// overwriting the default attemptedTransition attribute from the Ember.Controller object</span>
</span><span class='line'><span class="nx">attemptedTransition</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// create and set the token &amp; current user objects based on the respective cookies</span>
</span><span class='line'><span class="nx">token</span><span class="o">:</span>               <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">),</span>
</span><span class='line'><span class="nx">currentUser</span><span class="o">:</span>         <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;auth_user&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>The ApplicationController</h1>

<p>On our application controller we should set up some way to retrieve <em>application</em> wide the authenticated user data, if any. So we will read from the <code>SessionsController</code> object&rsquo;s properties.</p>

<figure class='code'><figcaption><span>app/assets/javascript/controllers/application_controller.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Auth</span><span class="p">.</span><span class="nx">ApplicationController</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="c1">// requires the sessions controller</span>
</span><span class='line'>  <span class="nx">needs</span><span class="o">:</span>           <span class="p">[</span><span class="s1">&#39;sessions&#39;</span><span class="p">],</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// creates a computed property called currentUser that will be</span>
</span><span class='line'>  <span class="c1">// binded on the curretUser of the sessions controller and will return its value</span>
</span><span class='line'>  <span class="nx">currentUser</span><span class="o">:</span>     <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;controllers.sessions.currentUser&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}).</span><span class="nx">property</span><span class="p">(</span><span class="s1">&#39;controllers.sessions.currentUser&#39;</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// creates a computed property called isAuthenticated that will be</span>
</span><span class='line'>  <span class="c1">// binded on the curretUser of the sessions controller and will verify if the object is empty</span>
</span><span class='line'>  <span class="nx">isAuthenticated</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">!</span><span class="nx">Ember</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;controllers.sessions.currentUser&#39;</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}).</span><span class="nx">property</span><span class="p">(</span><span class="s1">&#39;controllers.sessions.currentUser&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ember has a clever way to make different controllers comunicate between each other, that is done by the controller&rsquo;s dependencies. That&rsquo;s what we do when we decleare <code>needs: ['sessions']</code>, to read more about controlllers dependencies go to the Ember&rsquo;s guide to <a href="http://emberjs.com/guides/controllers/dependencies-between-controllers/">Dependencies between controllers</a>.</p>

<p>With that set up we create <a href="http://emberjs.com/guides/object-model/computed-properties/">computed properties</a> that will automatically update the <code>ApplicationController</code>&rsquo;s properties.</p>

<h1>Connecting everything with routes</h1>

<p>Now it&rsquo;s time to connect all those parts overwriting the routes objects created by Ember to each <code>this.route</code>or <code>this.resource</code> that we declared on our <code>Auth.Router</code> object. First, let&rsquo;s create our global logout action to reset the <code>SessionsController</code>&rsquo;s properties.</p>

<figure class='code'><figcaption><span>app/assets/javascript/routes/application_route.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Auth</span><span class="p">.</span><span class="nx">ApplicationRoute</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// create a global logout action</span>
</span><span class='line'>    <span class="nx">logout</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// get the sessions controller instance and reset it to then transition to the sessions route</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">controllerFor</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">).</span><span class="nx">reset</span><span class="p">();</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>With that in mind, in our <code>SessionsRoute</code>, it would be good if we clear out the <code>SessionsController</code>&rsquo;s properties each time a user visits the /sessions url to avoid showing the user left over data from the last authentication. For that, Ember&rsquo;s Route object has a special hook to <a href="http://emberjs.com/guides/routing/setting-up-a-controller/">setup the controller</a> before the transition.</p>

<figure class='code'><figcaption><span>app/assets/javascript/routes/sessions_route.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">// setup the SessionsController by resetting it to avoid data from a past authentication</span>
</span><span class='line'>  <span class="nx">setupController</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">controller</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, it would be a good idea to see if the user isn&rsquo;t already signed, so in that case we can take our user to the secret route instead of showing the login form.</p>

<figure class='code'><figcaption><span>app/assets/javascript/routes/sessions_route.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">beforeModel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transition</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// before proceeding any further, verify if the token property is not empty</span>
</span><span class='line'>    <span class="c1">// if it is, transition to the secret route</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Ember</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controllerFor</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">&#39;secret&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And for the cases that a unauthenticated user tries to access a protected route, we should be able to redirect him to the login route. Previewing that we might have another routes that will be for logged in users only, it would be better to have a base object to extend this basic functionality, instead of rewriting this on every protected route. Luckly enought Ember object&rsquo;s can be <a href="http://emberjs.com/guides/object-model/classes-and-instances/">extended/inherit from others</a>. So we will create a <code>AuthenticatedRoute</code> that will serve as our base route for those cases.</p>

<figure class='code'><figcaption><span>app/assets/javascript/routes/authenticated_route.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">create</span> <span class="nx">a</span> <span class="nx">base</span> <span class="nx">object</span> <span class="k">for</span> <span class="nx">any</span> <span class="nx">authentication</span> <span class="kr">protected</span> <span class="nx">route</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">required</span> <span class="nx">verifications</span>
</span><span class='line'><span class="c1">// create a base object for any authentication protected route with the required verifications</span>
</span><span class='line'><span class="nx">Auth</span><span class="p">.</span><span class="nx">AuthenticatedRoute</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="c1">// verify if the token property of the sessions controller is set before continuing with the request</span>
</span><span class='line'>  <span class="c1">// if it is not, redirect to the login route (sessions)</span>
</span><span class='line'>  <span class="nx">beforeModel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transition</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">Ember</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controllerFor</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">redirectToLogin</span><span class="p">(</span><span class="nx">transition</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="c1">// Redirect to the login page and store the current transition so we can</span>
</span><span class='line'>  <span class="c1">// run it again after login</span>
</span><span class='line'>  <span class="nx">redirectToLogin</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transition</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">controllerFor</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;attemptedTransition&#39;</span><span class="p">,</span> <span class="nx">transition</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Based on that, we can also rescue from any error that might happen from unauthorised access to other protected routes on this route. To do so, we simply have to indicate what the default <a href="http://emberjs.com/guides/routing/loading-and-error-substates/">Ember&rsquo;s error action</a> on that route should do.</p>

<figure class='code'><figcaption><span>app/assets/javascript/routes/authenticated_route.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// recover from any error that may happen during the transition to this route</span>
</span><span class='line'>    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">transition</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// if the HTTP status is 401 (unauthorised), redirect to the login page</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">reason</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">401</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">redirectToLogin</span><span class="p">(</span><span class="nx">transition</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;unknown problem&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that, we simply make our <code>SecretRoute</code> inherit from the <code>AuthenticatedRoute</code> and define it&rsquo;s model to be a list of the existing users on the api.</p>

<figure class='code'><figcaption><span>app/assets/javascript/routes/secret_route.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Auth</span><span class="p">.</span><span class="nx">SecretRoute</span> <span class="o">=</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">AuthenticatedRoute</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">model</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// instantiate the model for the SecretController as a list of created users</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h1>So long and thanks for the fish</h1>

<p>On the <a href="https://github.com/WebCloud/EmberJS-Auth-Example">EmberJS-Auth-Example</a> source code you will also find the signup process, not covered in this tutorial as it would become too extensive, feel free to browse around and change as you wish.</p>

<p>If you wish to learn more about Ember.js you will find some good material on the links above:</p>

<ul>
<li><a href="http://emberjs.com/guides/">Ember.JS Guides</a></li>
<li><a href="http://emberwatch.com/">EmberWatch</a></li>
<li><a href="http://www.manning.com/skeie/">Ember.js in Action</a></li>
</ul>


<br />

</section>



	
	  <section class="comments">
	    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
	  </section>
	
</article>
</div>

    </div>
  </div>
  <footer class="main-footer">
	<section class="interior-footer">
		<span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
	</section>
</footer>


  


<script type="text/javascript">
      var disqus_shortname = 'webcloudblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://WebCloud.github.io/blog/2014/04/07/emberjs-authentication-the-right-way-javascript-version/';
        var disqus_url = 'http://WebCloud.github.io/blog/2014/04/07/emberjs-authentication-the-right-way-javascript-version/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
